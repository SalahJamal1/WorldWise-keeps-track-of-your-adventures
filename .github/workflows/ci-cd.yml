name: CI/CD Pipeline 

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: db2025
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -h localhost"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3

        steps:
            # ------------------------------
            # 1. Checkout Repo
            # ------------------------------
            - name: Checkout code
              uses: actions/checkout@v4

            # ------------------------------
            # 2. Setup Node.js for Next.js
            # ------------------------------
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm
                  cache-dependency-path: client/package-lock.json

            - name: Build Frontend
              working-directory: client
              run: |
                  npm ci
                  npm run build

            # ------------------------------
            # 3. Setup .NET 8
            # ------------------------------
            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 8.0.x

            - name: Restore Dependencies
              working-directory: server
              run: dotnet restore

            # ------------------------------
            # 4. Wait for MySQL to be ready
            # ------------------------------
            - name: Wait for MySQL
              run: |
                  echo "Waiting for MySQL..."
                  for i in {1..20}; do
                    if mysqladmin ping -h 127.0.0.1 -uroot -proot --silent; then
                      echo "MySQL is up!";
                      break;
                    fi
                    echo "MySQL not ready yet..."
                    sleep 3
                  done

            # ------------------------------
            # 5. Build & Test .NET Project
            # ------------------------------
            - name: Build Project
              working-directory: server
              run: dotnet build --configuration Release

            - name: Run Tests
              working-directory: server
              env:
                  ConnectionStrings__DefaultConnection: "server=127.0.0.1;port=3306;user=root;password=root;database=db2025"
              run: dotnet test --no-build --verbosity normal

            # ------------------------------
            # 6. Publish .NET App
            # ------------------------------
            - name: Publish .NET App
              if: github.ref == 'refs/heads/main'
              working-directory: server
              run: dotnet publish -c Release -o ./publish

            # ------------------------------
            # 7. Build & Push Docker Image
            # ------------------------------
            - name: Build & Push Docker Image
              if: github.ref == 'refs/heads/main'
              env:
                  DOCKER_USER: ${{ secrets.DOCKER_USER }}
                  DOCKER_PASS: ${{ secrets.DOCKER_PASS }}
              run: |
                  echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                  docker build -t $DOCKER_USER/mappy-backend:latest ./server
                  docker push $DOCKER_USER/mappy-backend:latest
